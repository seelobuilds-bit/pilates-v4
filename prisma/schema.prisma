generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  HQ_ADMIN
  SALES_AGENT
  OWNER
  TEACHER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(OWNER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Password reset
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?

  ownedStudio Studio?
  teacher     Teacher?
  
  // Social media homework for studio owners
  homeworkSubmissions SocialHomeworkSubmission[]
  
  // The Vault - Course Platform (for studio owners)
  vaultEnrollments        VaultEnrollment[]
  vaultBundleSubscriptions VaultBundleSubscription[]
  vaultReviews            VaultReview[]
  vaultSubscriptions      VaultSubscriber[] @relation("VaultUserSubscription")
  
  // Support conversations
  supportConversations    SupportConversation[]
  
  // Sales CRM (for HQ staff)
  salesAgent              SalesAgent?
}

model Studio {
  id           String   @id @default(cuid())
  name         String
  subdomain    String   @unique
  primaryColor String?  @default("#7c3aed")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ownerId String @unique
  owner   User   @relation(fields: [ownerId], references: [id])

  // Stripe Connect settings
  stripeAccountId       String?   @unique
  stripeOnboardingComplete Boolean @default(false)
  stripeChargesEnabled  Boolean   @default(false)
  stripePayoutsEnabled  Boolean   @default(false)
  stripeDetailsSubmitted Boolean  @default(false)
  stripeCurrency        String?   @default("usd")

  locations     Location[]
  classTypes    ClassType[]
  teachers      Teacher[]
  clients       Client[]
  classSessions ClassSession[]
  bookings      Booking[]
  payments      Payment[]
  waitlists     Waitlist[]
  
  // Communication settings
  emailConfig   StudioEmailConfig?
  smsConfig     StudioSmsConfig?
  messages      Message[]
  campaigns     Campaign[]
  automations   Automation[]
  segments      Segment[]
  templates     MessageTemplate[]
  systemEmails  SystemEmailTemplate[]
  systemSms     SystemSmsTemplate[]
  hqMessages    HQMessage[]
  
  // Website Analytics
  websiteConfig   WebsiteAnalyticsConfig?
  websiteEvents   WebsiteEvent[]
  websiteVisitors WebsiteVisitor[]
  
  // Teacher Invoices
  teacherInvoices TeacherInvoice[]
  
  // Class Flows & Training
  classFlowProgress ClassFlowProgress[]
  trainingRequests  TrainingRequest[]
  
  // Social Media Marketing
  socialAccounts      SocialMediaAccount[]
  socialTrackingLinks SocialMediaTrackingLink[]
  
  // The Vault - Course Platform
  vaultCourses        VaultCourse[]
  vaultBundles        VaultBundle[]
  vaultSubscriptionPlans VaultSubscriptionPlan[]
  
  // E-commerce Store
  merchStore          StudioStore?
}

// Email configuration per studio
model StudioEmailConfig {
  id                String   @id @default(cuid())
  
  // Sender settings
  fromName          String   // Display name (e.g., "Zenith Pilates")
  fromEmail         String?  // Custom from address (e.g., "hello") - combined with domain
  replyToEmail      String?  // Reply-to address (optional)
  
  // Domain verification (via Resend)
  domain            String?  // e.g., "zenithpilates.com"
  resendDomainId    String?  // Resend's domain ID
  domainStatus      String   @default("not_started") // not_started, pending, verified, failed
  dnsRecords        Json?    // DNS records to display to user
  verifiedAt        DateTime?
  
  // Fallback - if domain not verified, use platform email
  useFallback       Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  studioId String @unique
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

// SMS configuration per studio
model StudioSmsConfig {
  id                String   @id @default(cuid())
  provider          String   @default("twilio") // twilio, messagebird, vonage
  accountSid        String?  // encrypted
  authToken         String?  // encrypted
  fromNumber        String   // sender phone number
  
  // Verification status
  isVerified        Boolean  @default(false)
  verifiedAt        DateTime?
  
  // Usage limits
  monthlyLimit      Int      @default(1000)
  currentMonthUsage Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  studioId String @unique
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

// Message types
enum MessageChannel {
  EMAIL
  SMS
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  DRAFT
  QUEUED
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

// All messages (inbox conversations)
model Message {
  id            String           @id @default(cuid())
  channel       MessageChannel
  direction     MessageDirection
  status        MessageStatus    @default(QUEUED)
  
  // Content
  subject       String?          // for emails
  body          String           @db.Text
  htmlBody      String?          @db.Text // for emails
  
  // Sender/Recipient
  fromAddress   String           // email or phone
  toAddress     String           // email or phone
  fromName      String?
  toName        String?
  
  // Thread tracking for replies
  threadId      String?          // Unique ID for conversation thread
  replyToId     String?          // ID of message this is replying to
  
  // Tracking
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  failedReason  String?
  
  // External IDs (from email/sms provider)
  externalId    String?
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  studioId      String
  studio        Studio           @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  clientId      String?
  client        Client?          @relation(fields: [clientId], references: [id])
  
  // Link to campaign if sent via marketing
  campaignId    String?
  campaign      Campaign?        @relation(fields: [campaignId], references: [id])
  
  automationId  String?
  automation    Automation?      @relation(fields: [automationId], references: [id])

  @@index([studioId, clientId])
  @@index([studioId, createdAt])
  @@index([threadId])
}

// HQ Communications with Studios
model HQMessage {
  id            String           @id @default(cuid())
  channel       MessageChannel   @default(EMAIL)
  direction     MessageDirection
  status        MessageStatus    @default(QUEUED)
  
  // Content
  subject       String?
  body          String           @db.Text
  htmlBody      String?          @db.Text
  
  // Sender/Recipient
  fromAddress   String
  toAddress     String
  fromName      String?
  toName        String?
  
  // Thread tracking
  threadId      String?
  replyToId     String?
  
  // Tracking
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  failedReason  String?
  
  externalId    String?
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Link to studio OR lead (one must be set)
  studioId      String?
  studio        Studio?          @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  leadId        String?
  lead          Lead?            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Sender (HQ admin)
  senderId      String?          // User ID of HQ admin who sent
  
  @@index([studioId, createdAt])
  @@index([leadId, createdAt])
  @@index([threadId])
}

// Marketing Campaigns
enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

model Campaign {
  id            String         @id @default(cuid())
  name          String
  channel       MessageChannel
  status        CampaignStatus @default(DRAFT)
  
  // Content
  subject       String?        // for emails
  body          String         @db.Text
  htmlBody      String?        @db.Text
  
  // Scheduling
  scheduledAt   DateTime?
  sentAt        DateTime?
  
  // Targeting
  targetAll     Boolean        @default(false)
  
  // Stats
  totalRecipients Int          @default(0)
  sentCount       Int          @default(0)
  deliveredCount  Int          @default(0)
  openedCount     Int          @default(0)
  clickedCount    Int          @default(0)
  failedCount     Int          @default(0)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  studioId      String
  studio        Studio         @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  // Target segment (optional)
  segmentId     String?
  segment       Segment?       @relation(fields: [segmentId], references: [id])
  
  // Target location (optional)
  locationId    String?
  location      Location?      @relation(fields: [locationId], references: [id])
  
  // Template used (optional)
  templateId    String?
  template      MessageTemplate? @relation(fields: [templateId], references: [id])
  
  messages      Message[]

  @@index([studioId, status])
}

// Marketing Automations
enum AutomationStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum AutomationTrigger {
  WELCOME           // New client signup
  CLASS_REMINDER    // Before class
  CLASS_FOLLOWUP    // After class
  BOOKING_CONFIRMED // When booking is made
  BOOKING_CANCELLED // When booking is cancelled
  CLIENT_INACTIVE   // Client hasn't booked in X days
  BIRTHDAY          // Client birthday
  MEMBERSHIP_EXPIRING // Membership about to expire
}

model Automation {
  id            String            @id @default(cuid())
  name          String
  trigger       AutomationTrigger
  channel       MessageChannel
  status        AutomationStatus  @default(DRAFT)
  
  // Content
  subject       String?           // for emails
  body          String            @db.Text
  htmlBody      String?           @db.Text
  
  // Trigger settings
  triggerDelay  Int               @default(0) // minutes before/after trigger
  triggerDays   Int?              // for CLIENT_INACTIVE - days of inactivity
  reminderHours Int?              // for CLASS_REMINDER - hours before class
  
  // Stats
  totalSent     Int               @default(0)
  totalDelivered Int              @default(0)
  totalOpened   Int               @default(0)
  totalClicked  Int               @default(0)
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  studioId      String
  studio        Studio            @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  // Target location (optional - all if not set)
  locationId    String?
  location      Location?         @relation(fields: [locationId], references: [id])
  
  // Template used (optional)
  templateId    String?
  template      MessageTemplate?  @relation(fields: [templateId], references: [id])
  
  messages      Message[]

  @@index([studioId, status, trigger])
}

// Client Segments for targeting
model Segment {
  id            String    @id @default(cuid())
  name          String
  description   String?
  
  // Filter rules (JSON structure)
  rules         String    @db.Text // JSON: { "conditions": [...], "operator": "AND" }
  
  // Cached count
  clientCount   Int       @default(0)
  lastCalculated DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  studioId      String
  studio        Studio    @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  campaigns     Campaign[]

  @@index([studioId])
}

// Message Templates
enum TemplateType {
  EMAIL
  SMS
}

model MessageTemplate {
  id            String       @id @default(cuid())
  name          String
  type          TemplateType
  
  // Content
  subject       String?      // for emails
  body          String       @db.Text
  htmlBody      String?      @db.Text
  
  // Variables available (e.g., {{firstName}}, {{className}})
  variables     String[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  studioId      String
  studio        Studio       @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  campaigns     Campaign[]
  automations   Automation[]

  @@index([studioId, type])
}

// System Email Templates (transactional emails)
enum SystemEmailType {
  BOOKING_CONFIRMATION       // When a client books a class
  CLASS_REMINDER_24HR        // 24 hours before class
  CLASS_REMINDER_1HR         // 1 hour before class
  CLASS_CANCELLED_BY_STUDIO  // When studio cancels a class
  CLASS_CANCELLED_BY_CLIENT  // When client cancels their booking
  WAITLIST_NOTIFICATION      // When a spot opens up on waitlist
  WAITLIST_CONFIRMED         // When client claims waitlist spot
  PAYMENT_SUCCESS            // When payment/rebill succeeds
  PAYMENT_FAILED             // When payment/rebill fails
  PAYMENT_REFUND             // When a refund is processed
  PASSWORD_RESET             // Forgotten password email
  WELCOME                    // Welcome email for new clients
  TEACHER_INVITE             // When a teacher is invited to the studio
  CLIENT_WELCOME             // Welcome email when client registers
}

// SMS Template Types
enum SystemSmsType {
  BOOKING_CONFIRMATION       // When a client books a class
  CLASS_REMINDER_24HR        // 24 hours before class
  CLASS_REMINDER_1HR         // 1 hour before class
  CLASS_CANCELLED            // When class is cancelled
  WAITLIST_NOTIFICATION      // When a spot opens up on waitlist
}

// SMS Templates per studio
model SystemSmsTemplate {
  id            String        @id @default(cuid())
  type          SystemSmsType
  name          String        // Display name for the template
  body          String        @db.Text // SMS message body (160 chars recommended)
  isEnabled     Boolean       @default(true)
  
  // Available variables for this template type
  variables     String[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  studioId      String
  studio        Studio        @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([studioId, type])
  @@index([studioId])
}

model SystemEmailTemplate {
  id            String          @id @default(cuid())
  type          SystemEmailType
  name          String          // Display name for the template
  subject       String          // Email subject line
  body          String          @db.Text // Plain text version
  htmlBody      String          @db.Text // HTML version
  isEnabled     Boolean         @default(true)
  
  // Available variables for this template type
  variables     String[]
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  studioId      String
  studio        Studio          @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([studioId, type])
  @@index([studioId])
}

model Location {
  id        String   @id @default(cuid())
  name      String
  address   String
  city      String
  state     String
  zipCode   String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studioId String
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)

  classSessions ClassSession[]
  campaigns     Campaign[]
  automations   Automation[]
}

model ClassType {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int      @default(60)
  capacity    Int      @default(10)
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studioId String
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)

  classSessions ClassSession[]
}

model Teacher {
  id          String   @id @default(cuid())
  bio         String?
  specialties String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  studioId String
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)

  classSessions     ClassSession[]
  blockedTimes      TeacherBlockedTime[]
  payRate           TeacherPayRate?
  invoices          TeacherInvoice[]
  classFlowProgress ClassFlowProgress[]
  trainingRequests  TrainingRequest[]
  
  // Social Media Marketing
  socialAccounts          SocialMediaAccount[]
  socialTrackingLinks     SocialMediaTrackingLink[]
  socialTrainingProgress  SocialTrainingProgress[]
  socialHomeworkSubmissions SocialHomeworkSubmission[]
  socialEventRegistrations  SocialEventRegistration[]
  
  // The Vault - Course Platform
  createdCourses          VaultCourse[] @relation("VaultCourseCreator")
  instructorRoles         VaultCourseInstructor[]
  vaultEnrollments        VaultEnrollment[]
  vaultAffiliateLinks     VaultAffiliateLink[]
  vaultBundleSubscriptions VaultBundleSubscription[]
  vaultReviews            VaultReview[]
  vaultSubscriptions      VaultSubscriber[] @relation("VaultTeacherSubscription")
}

// Teacher blocked/unavailable times
model TeacherBlockedTime {
  id          String   @id @default(cuid())
  startTime   DateTime
  endTime     DateTime
  reason      String?  // Optional reason (e.g., "Vacation", "Personal", "Training")
  isRecurring Boolean  @default(false)
  recurringDays Int[]  // Day of week (0-6) if recurring
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId, startTime, endTime])
}

// Teacher pay rate configuration
enum PayRateType {
  PER_CLASS     // Fixed amount per class taught
  PER_HOUR      // Hourly rate
  PER_STUDENT   // Amount per student that attends
  PERCENTAGE    // Percentage of class revenue
}

model TeacherPayRate {
  id            String      @id @default(cuid())
  type          PayRateType @default(PER_CLASS)
  rate          Float       // Amount in currency
  currency      String      @default("USD")
  
  // Optional overrides per class type
  classTypeRates String?    @db.Text // JSON: { classTypeId: rate }
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  teacherId     String      @unique
  teacher       Teacher     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
}

// Teacher invoice status
enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  CANCELLED
}

model TeacherInvoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        // e.g., INV-2024-001
  status          InvoiceStatus @default(DRAFT)
  
  // Period covered
  periodStart     DateTime
  periodEnd       DateTime
  
  // Line items stored as JSON
  lineItems       String        @db.Text // JSON array of { description, classId?, quantity, rate, amount }
  
  // Totals
  subtotal        Float
  tax             Float         @default(0)
  taxRate         Float         @default(0)
  total           Float
  
  // Payment info
  currency        String        @default("USD")
  notes           String?       @db.Text
  
  // Sent/Paid tracking
  sentAt          DateTime?
  paidAt          DateTime?
  paidAmount      Float?
  paymentMethod   String?
  paymentReference String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  teacherId       String
  teacher         Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  studioId        String
  studio          Studio        @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@index([teacherId, periodStart])
  @@index([studioId, invoiceNumber])
}

model Client {
  id                  String   @id @default(cuid())
  email               String
  password            String?
  firstName           String
  lastName            String
  phone               String?
  birthday            DateTime?
  isActive            Boolean  @default(true)
  credits             Int      @default(0)
  stripeCustomerId    String?  // Stripe customer ID for this client at this studio
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Password reset
  resetToken          String?
  resetTokenExpiry    DateTime?

  studioId String
  studio   Studio @relation(fields: [studioId], references: [id], onDelete: Cascade)

  bookings Booking[]
  messages Message[]
  payments Payment[]
  
  // The Vault - Course Platform
  vaultEnrollments        VaultEnrollment[]
  vaultBundleSubscriptions VaultBundleSubscription[]
  vaultReviews            VaultReview[]
  vaultSubscriptions      VaultSubscriber[] @relation("VaultClientSubscription")
  
  // E-commerce Orders
  merchOrders             MerchOrder[]
  
  // Waitlist entries
  waitlists               Waitlist[]

  @@unique([email, studioId])
}

model ClassSession {
  id        String   @id @default(cuid())
  startTime DateTime
  endTime   DateTime
  capacity  Int
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Recurring class tracking
  recurringGroupId String?  // Groups recurring classes together for bulk operations

  studioId    String
  studio      Studio    @relation(fields: [studioId], references: [id], onDelete: Cascade)
  classTypeId String
  classType   ClassType @relation(fields: [classTypeId], references: [id])
  teacherId   String
  teacher     Teacher   @relation(fields: [teacherId], references: [id])
  locationId  String
  location    Location  @relation(fields: [locationId], references: [id])

  bookings  Booking[]
  waitlists Waitlist[]
  
  @@index([recurringGroupId])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Booking {
  id         String        @id @default(cuid())
  status     BookingStatus @default(PENDING)
  paidAmount Float?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  studioId       String
  studio         Studio       @relation(fields: [studioId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  classSessionId String
  classSession   ClassSession @relation(fields: [classSessionId], references: [id])
  
  // Payment
  paymentId      String?
  payment        Payment?     @relation(fields: [paymentId], references: [id])
  
  // Cancellation tracking
  cancelledAt        DateTime?
  cancellationReason String?
  
  // Prevent same client booking same class twice
  @@unique([clientId, classSessionId])
  @@index([studioId, status])
  @@index([classSessionId, status])
}

// Waitlist for full classes
model Waitlist {
  id        String   @id @default(cuid())
  position  Int      // Position in the waitlist queue
  status    WaitlistStatus @default(WAITING)
  notifiedAt DateTime? // When they were notified of an opening
  expiresAt  DateTime? // Deadline to claim the spot
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studioId       String
  studio         Studio       @relation(fields: [studioId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  classSessionId String
  classSession   ClassSession @relation(fields: [classSessionId], references: [id])

  // Prevent same client joining waitlist for same class twice
  @@unique([clientId, classSessionId])
  @@index([classSessionId, status])
  @@index([classSessionId, position])
}

enum WaitlistStatus {
  WAITING    // In queue
  NOTIFIED   // Spot opened, client notified
  CLAIMED    // Client claimed the spot (booking created)
  EXPIRED    // Notification expired, moved to next person
  CANCELLED  // Client removed themselves
}

// Payment tracking
enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Payment {
  id                    String        @id @default(cuid())
  amount                Float         // Amount in cents
  currency              String        @default("usd")
  status                PaymentStatus @default(PENDING)
  
  // Stripe IDs
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  stripeRefundId        String?
  
  // For checkout sessions
  stripeCheckoutSessionId String?     @unique
  
  // Fees
  stripeFee             Float?        // Stripe's fee
  applicationFee        Float?        // Our platform fee (if any)
  netAmount             Float?        // Amount after fees
  
  // Metadata
  description           String?
  receiptUrl            String?
  failureMessage        String?
  
  // Refund tracking
  refundedAmount        Float?
  refundedAt            DateTime?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  studioId              String
  studio                Studio        @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  clientId              String
  client                Client        @relation(fields: [clientId], references: [id])
  
  bookings              Booking[]

  @@index([studioId, createdAt])
  @@index([stripePaymentIntentId])
}

// Website Analytics Configuration
model WebsiteAnalyticsConfig {
  id              String   @id @default(cuid())
  trackingId      String   @unique @default(cuid()) // Unique ID for the tracking script
  websiteUrl      String?  // Main website URL
  platform        String?  // wordpress, wix, shopify, squarespace, custom, etc.
  isEnabled       Boolean  @default(true)
  
  // Tracking settings
  trackPageViews  Boolean  @default(true)
  trackClicks     Boolean  @default(true)
  trackForms      Boolean  @default(true)
  trackScrollDepth Boolean @default(false)
  trackOutboundLinks Boolean @default(true)
  
  // Conversion tracking
  conversionGoals String?  @db.Text // JSON array of conversion goals
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studioId        String   @unique
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
}

// Website Visitors (unique visitors)
model WebsiteVisitor {
  id              String   @id @default(cuid())
  visitorId       String   // Anonymous visitor ID (stored in cookie)
  
  // Visitor info
  firstVisit      DateTime @default(now())
  lastVisit       DateTime @default(now())
  totalVisits     Int      @default(1)
  totalPageViews  Int      @default(0)
  
  // Device/Browser info
  userAgent       String?
  browser         String?
  os              String?
  device          String?  // desktop, mobile, tablet
  
  // Location (from IP)
  country         String?
  city            String?
  
  // Source attribution
  firstSource     String?  // Where they first came from
  firstMedium     String?  // organic, paid, referral, direct, social
  firstCampaign   String?  // UTM campaign
  
  // Conversion status
  hasConverted    Boolean  @default(false)
  convertedAt     DateTime?
  
  // Link to client if they become one
  clientId        String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studioId        String
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  events          WebsiteEvent[]

  @@unique([studioId, visitorId])
  @@index([studioId, lastVisit])
  @@index([studioId, hasConverted])
}

// Website Events (page views, clicks, conversions, etc.)
enum WebsiteEventType {
  PAGE_VIEW
  CLICK
  FORM_SUBMIT
  SCROLL_DEPTH
  OUTBOUND_LINK
  CONVERSION
  CUSTOM
}

model WebsiteEvent {
  id              String           @id @default(cuid())
  type            WebsiteEventType
  
  // Page info
  pageUrl         String
  pageTitle       String?
  pagePath        String?
  
  // Event details
  eventName       String?          // For custom events
  eventData       String?          @db.Text // JSON data
  
  // Click tracking
  elementId       String?
  elementClass    String?
  elementText     String?
  
  // Scroll depth
  scrollDepth     Int?             // Percentage 0-100
  
  // Referrer
  referrer        String?
  
  // UTM parameters
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  
  // Session info
  sessionId       String?
  
  createdAt       DateTime         @default(now())

  studioId        String
  studio          Studio           @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  visitorId       String?
  visitor         WebsiteVisitor?  @relation(fields: [visitorId], references: [id])

  @@index([studioId, createdAt])
  @@index([studioId, type])
  @@index([studioId, pagePath])
}

// ==========================================
// CLASS FLOWS & TRAINING CONTENT
// ==========================================

// Class flow categories (Reformer, Mat, Tower, etc.)
model ClassFlowCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?  // Icon name or emoji
  color       String?  // Hex color for styling
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contents    ClassFlowContent[]
}

// Content types
enum ContentType {
  VIDEO
  PDF
  ARTICLE
  QUIZ
}

// Difficulty levels
enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// Individual class flow content items
model ClassFlowContent {
  id              String          @id @default(cuid())
  title           String
  description     String?         @db.Text
  type            ContentType
  difficulty      DifficultyLevel @default(BEGINNER)
  
  // Content URLs
  videoUrl        String?         // YouTube, Vimeo, or hosted video URL
  thumbnailUrl    String?         // Preview image
  pdfUrl          String?         // PDF file URL
  articleContent  String?         @db.Text // Rich text content for articles
  
  // Duration in minutes (for videos)
  duration        Int?
  
  // Ordering and status
  order           Int             @default(0)
  isPublished     Boolean         @default(true)
  isFeatured      Boolean         @default(false)
  
  // Metadata
  tags            String[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  categoryId      String
  category        ClassFlowCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  progress        ClassFlowProgress[]

  @@index([categoryId])
  @@index([type])
  @@index([difficulty])
}

// Track teacher progress on class flows
model ClassFlowProgress {
  id              String   @id @default(cuid())
  
  // Progress tracking
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  lastViewedAt    DateTime @default(now())
  progressPercent Int      @default(0) // 0-100 for videos
  notes           String?  @db.Text    // Teacher's personal notes
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contentId       String
  content         ClassFlowContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  studioId        String
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)

  @@unique([contentId, teacherId])
  @@index([teacherId])
  @@index([studioId])
}

// Training request status
enum TrainingRequestStatus {
  PENDING
  APPROVED
  SCHEDULED
  COMPLETED
  CANCELLED
}

// On-site training requests
model TrainingRequest {
  id              String                @id @default(cuid())
  
  // Request details
  title           String
  description     String                @db.Text
  trainingType    String                // "reformer-advanced", "mat-certification", etc.
  
  // Preferred dates
  preferredDate1  DateTime?
  preferredDate2  DateTime?
  preferredDate3  DateTime?
  
  // Scheduling
  scheduledDate   DateTime?
  scheduledTime   String?               // e.g., "9:00 AM - 5:00 PM"
  
  // Status tracking
  status          TrainingRequestStatus @default(PENDING)
  
  // Contact info
  contactName     String
  contactEmail    String
  contactPhone    String?
  
  // Location (where training will be held)
  location        String?
  address         String?               @db.Text
  
  // Number of attendees
  attendeeCount   Int                   @default(1)
  
  // Notes
  notes           String?               @db.Text
  adminNotes      String?               @db.Text // Internal notes
  
  // Pricing (if applicable)
  estimatedCost   Float?
  finalCost       Float?
  
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  studioId        String
  studio          Studio                @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  requestedById   String
  requestedBy     Teacher               @relation(fields: [requestedById], references: [id])

  @@index([studioId, status])
  @@index([status])
}

// ==========================================
// SOCIAL MEDIA MARKETING SYSTEM
// ==========================================

// Social media platforms
enum SocialPlatform {
  INSTAGRAM
  TIKTOK
}

// Connected social media accounts
model SocialMediaAccount {
  id              String         @id @default(cuid())
  platform        SocialPlatform
  
  // Account info
  platformUserId  String         // Instagram/TikTok user ID
  username        String
  displayName     String?
  profilePicture  String?
  
  // OAuth tokens (encrypted in production)
  accessToken     String         @db.Text
  refreshToken    String?        @db.Text
  tokenExpiresAt  DateTime?
  
  // Account stats (updated periodically)
  followerCount   Int            @default(0)
  followingCount  Int            @default(0)
  postsCount      Int            @default(0)
  
  // Status
  isActive        Boolean        @default(true)
  lastSyncedAt    DateTime?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Can belong to studio or teacher
  studioId        String?
  studio          Studio?        @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher?       @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Relations
  flows           SocialMediaFlow[]
  messages        SocialMediaMessage[]
  trackingLinks   SocialMediaTrackingLink[]

  @@unique([platform, platformUserId])
  @@index([studioId])
  @@index([teacherId])
}

// Automation flow trigger types
enum FlowTriggerType {
  COMMENT_KEYWORD       // Comment on post/reel contains keyword
  STORY_REPLY           // Reply to story
  STORY_REACTION        // Reaction to story
  INBOUND_DM_KEYWORD    // DM contains keyword
  CLICK_TO_MESSAGE_AD   // From ad click
}

// Social media automation flows
model SocialMediaFlow {
  id              String          @id @default(cuid())
  name            String
  description     String?
  
  // Trigger configuration
  triggerType     FlowTriggerType
  triggerKeywords String[]        // Keywords that trigger the flow
  
  // Response configuration
  responseMessage String          @db.Text // Initial DM message
  followUpMessages String?        @db.Text // JSON array of follow-up messages with delays
  
  // Booking integration
  includeBookingLink Boolean      @default(true)
  bookingMessage    String?       // Message to include with booking link
  
  // Status
  isActive        Boolean         @default(true)
  
  // Stats
  totalTriggered  Int             @default(0)
  totalResponded  Int             @default(0)
  totalBooked     Int             @default(0)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  accountId       String
  account         SocialMediaAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Track which content/post this flow is for
  postId          String?         // Platform post ID
  postUrl         String?
  
  // Generated tracking links for this flow
  trackingLinks   SocialMediaTrackingLink[]
  
  // Triggered events
  events          SocialMediaFlowEvent[]
  
  // Homework submissions using this flow for tracking
  homeworkSubmissions SocialHomeworkSubmission[]

  @@index([accountId])
  @@index([triggerType])
}

// Track individual flow trigger events
model SocialMediaFlowEvent {
  id              String   @id @default(cuid())
  
  // User who triggered
  platformUserId  String   // Instagram/TikTok user ID
  platformUsername String?
  
  // What triggered it
  triggerContent  String?  @db.Text // The comment/message content
  triggerType     FlowTriggerType
  
  // Response sent
  responseSent    Boolean  @default(false)
  responseAt      DateTime?
  
  // Conversion tracking
  clickedLink     Boolean  @default(false)
  clickedAt       DateTime?
  converted       Boolean  @default(false) // Made a booking
  convertedAt     DateTime?
  bookingId       String?  // Link to booking if converted
  
  createdAt       DateTime @default(now())

  flowId          String
  flow            SocialMediaFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId, createdAt])
  @@index([converted])
}

// Tracking links for attribution
model SocialMediaTrackingLink {
  id              String   @id @default(cuid())
  
  // Unique tracking code
  code            String   @unique @default(cuid())
  
  // What this tracks
  campaign        String?  // Campaign name
  source          String   // instagram, tiktok
  medium          String   // comment_reply, dm, story, ad
  content         String?  // Specific post/reel ID
  
  // The actual booking URL with tracking
  destinationUrl  String
  fullTrackingUrl String   // The complete URL with all params
  
  // Stats
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  revenue         Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Attribution
  accountId       String?
  account         SocialMediaAccount? @relation(fields: [accountId], references: [id])
  
  flowId          String?
  flow            SocialMediaFlow? @relation(fields: [flowId], references: [id])
  
  studioId        String?
  studio          Studio?  @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher? @relation(fields: [teacherId], references: [id])

  @@index([code])
  @@index([studioId])
  @@index([teacherId])
}

// Social media messages (for inbox)
model SocialMediaMessage {
  id              String         @id @default(cuid())
  platform        SocialPlatform
  
  // Conversation participant
  platformUserId  String         // Their user ID
  platformUsername String?
  profilePicture  String?
  
  // Message content
  direction       MessageDirection // INBOUND or OUTBOUND
  content         String         @db.Text
  mediaUrl        String?        // If message has media
  mediaType       String?        // image, video, etc.
  
  // Platform message ID
  platformMessageId String?
  
  // Status
  isRead          Boolean        @default(false)
  readAt          DateTime?
  
  // Automation flag
  isAutomated     Boolean        @default(false)
  flowId          String?        // If sent by a flow
  
  createdAt       DateTime       @default(now())

  accountId       String
  account         SocialMediaAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, platformUserId])
  @@index([accountId, createdAt])
  @@index([isRead])
}

// ==========================================
// SOCIAL MEDIA TRAINING SYSTEM
// ==========================================

// Training categories
model SocialTrainingCategory {
  id          String   @id @default(cuid())
  name        String   // e.g., "Profile Optimization", "Content Creation", "Editing"
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  modules     SocialTrainingModule[]
}

// Training modules
model SocialTrainingModule {
  id              String   @id @default(cuid())
  title           String
  description     String?  @db.Text
  
  // AI-generated summary of the module content
  summary         String?  @db.Text
  keyTakeaways    String?  @db.Text // JSON array of key points
  
  // Content
  videoUrl        String?
  thumbnailUrl    String?
  duration        Int?     // in minutes
  
  // Additional resources
  resources       String?  @db.Text // JSON array of { title, url, type }
  
  // Is this a live session?
  isLive          Boolean  @default(false)
  liveDate        DateTime?
  liveUrl         String?  // Zoom/Meet link
  
  // Is this an in-person event?
  isInPerson      Boolean  @default(false)
  eventLocation   String?
  eventAddress    String?
  maxAttendees    Int?
  
  // Ordering
  order           Int      @default(0)
  isPublished     Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  categoryId      String
  category        SocialTrainingCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Homework for this module
  homework        SocialTrainingHomework[]
  
  // Progress tracking
  progress        SocialTrainingProgress[]
  
  // Event registrations
  registrations   SocialEventRegistration[]

  @@index([categoryId])
}

// Homework assignments
model SocialTrainingHomework {
  id              String   @id @default(cuid())
  title           String
  description     String   @db.Text
  
  // Requirements
  requirements    String   @db.Text // JSON array of { task, quantity, metric }
  // e.g., [{ "task": "Create Instagram Reels", "quantity": 8, "metric": "reels_created" },
  //        { "task": "Set up auto-reply", "quantity": 1, "metric": "flow_created" },
  //        { "task": "Get bookings", "quantity": 3, "metric": "bookings" }]
  
  // AI-generated instructions based on module content
  aiInstructions  String?  @db.Text // JSON array of step-by-step instructions for each task
  
  // Due date (optional)
  dueInDays       Int?     // Days from assignment
  
  // Points/rewards
  points          Int      @default(10)
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  moduleId        String
  module          SocialTrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Submissions
  submissions     SocialHomeworkSubmission[]

  @@index([moduleId])
}

// Homework submissions
// Homework submission status
enum HomeworkStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model SocialHomeworkSubmission {
  id              String   @id @default(cuid())
  
  // Progress on requirements
  progress        String   @db.Text // JSON object tracking each requirement
  // e.g., { "reels_created": 5, "flow_created": 1, "bookings": 2 }
  
  // Status tracking
  status          HomeworkStatus @default(ACTIVE)
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  cancelledAt     DateTime?
  startedAt       DateTime @default(now())
  
  // Auto-generated tracking link for this homework
  trackingCode    String?  @unique
  fullTrackingUrl String?  @db.Text // The complete booking URL with tracking
  
  // Evidence/proof - video links submitted by user
  submissionNotes String?  @db.Text
  submissionUrls  String[] // URLs to content created (video links)
  
  // Attached automation flow for tracking
  attachedFlowId  String?
  attachedFlow    SocialMediaFlow? @relation(fields: [attachedFlowId], references: [id], onDelete: SetNull)
  
  // Feedback
  feedback        String?  @db.Text
  pointsAwarded   Int?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  homeworkId      String
  homework        SocialTrainingHomework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  
  // Can be done by either a teacher OR a studio owner (user)
  teacherId       String?
  teacher         Teacher?  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  userId          String?   // For studio owners doing homework
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, teacherId])
  @@unique([homeworkId, userId])
  @@index([teacherId])
  @@index([userId])
  @@index([attachedFlowId])
}

// Trending/Viral Content Discovery
model TrendingContent {
  id              String   @id @default(cuid())
  
  // Platform info
  platform        SocialPlatform
  platformPostId  String   @unique // Instagram/TikTok post ID
  postUrl         String
  
  // Creator info
  creatorUsername String
  creatorDisplayName String?
  creatorProfilePic String?
  creatorFollowers Int      @default(0)
  isVerified      Boolean  @default(false)
  
  // Content info
  contentType     SocialContentType @default(VIDEO)
  thumbnailUrl    String?
  videoUrl        String?
  caption         String?  @db.Text
  hashtags        String[] // Array of hashtags used
  
  // Engagement metrics
  viewCount       Int      @default(0)
  likeCount       Int      @default(0)
  commentCount    Int      @default(0)
  shareCount      Int      @default(0)
  saveCount       Int      @default(0)
  engagementRate  Float    @default(0) // (likes+comments+shares)/views * 100
  
  // Content categorization
  category        String?  // e.g., "Reformer", "Mat", "Props", "Transitions"
  contentStyle    String?  // e.g., "Tutorial", "Transformation", "Day in Life", "Tips"
  difficulty      String?  // e.g., "Beginner", "Intermediate", "Advanced"
  
  // Timing
  postedAt        DateTime
  scrapedAt       DateTime @default(now())
  lastUpdatedAt   DateTime @updatedAt
  
  // Trending score (calculated)
  trendingScore   Float    @default(0) // Algorithm-based score
  
  // Admin flags
  isFeatured      Boolean  @default(false)
  isHidden        Boolean  @default(false)
  
  @@index([platform])
  @@index([postedAt])
  @@index([trendingScore])
  @@index([category])
  @@index([viewCount])
  @@index([likeCount])
}

enum SocialContentType {
  VIDEO
  IMAGE
  CAROUSEL
  REEL
  STORY
}

// Training progress
model SocialTrainingProgress {
  id              String   @id @default(cuid())
  
  // Progress
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  watchedPercent  Int      @default(0) // 0-100
  lastWatchedAt   DateTime?
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  moduleId        String
  module          SocialTrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([moduleId, teacherId])
  @@index([teacherId])
}

// Event registrations
model SocialEventRegistration {
  id              String   @id @default(cuid())
  
  // Status
  isConfirmed     Boolean  @default(true)
  attendedAt      DateTime?
  
  createdAt       DateTime @default(now())

  moduleId        String
  module          SocialTrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([moduleId, teacherId])
}

// Weekly content ideas
model SocialContentIdea {
  id              String   @id @default(cuid())
  
  // Content
  title           String
  description     String   @db.Text
  category        String   // hooks, storytelling, offers, etc.
  
  // Example content
  exampleScript   String?  @db.Text
  exampleVideoUrl String?
  
  // For which week
  weekOf          DateTime // Start of the week
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([weekOf])
  @@index([category])
}

// ==================== THE VAULT - Course & Membership Platform ====================

// Course target audience
enum VaultAudience {
  STUDIO_OWNERS   // For pilates studio owners
  TEACHERS        // For pilates teachers
  CLIENTS         // For end clients (at-home, mentorship)
  ALL             // Available to everyone
}

// Course pricing model
enum VaultPricingType {
  FREE            // Free course
  ONE_TIME        // Single purchase
  SUBSCRIPTION    // Recurring access
  BUNDLE          // Part of a bundle/membership
}

// Access type
enum VaultAccessType {
  LIFETIME        // Forever access after purchase
  TIME_LIMITED    // Access for X days/months
  DRIP            // Content released over time
}

// Enrollment status
enum VaultEnrollmentStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  COMPLETED
}

// Main course model
model VaultCourse {
  id              String   @id @default(cuid())
  
  // Basic info
  title           String
  slug            String   @unique
  subtitle        String?
  description     String   @db.Text
  thumbnailUrl    String?
  promoVideoUrl   String?
  
  // Categorization
  audience        VaultAudience @default(CLIENTS)
  category        String?       // e.g., "Business Growth", "Teaching Skills", "At-Home Workouts"
  tags            String[]
  difficulty      String?       // Beginner, Intermediate, Advanced
  
  // Pricing
  pricingType     VaultPricingType @default(ONE_TIME)
  price           Float            @default(0)
  currency        String           @default("USD")
  
  // Subscription options (if pricingType is SUBSCRIPTION)
  subscriptionInterval String?     // monthly, quarterly, yearly
  subscriptionPrice    Float?
  
  // Access settings
  accessType      VaultAccessType @default(LIFETIME)
  accessDays      Int?            // For TIME_LIMITED: number of days
  dripIntervalDays Int?           // For DRIP: days between releases
  
  // Features (Note: Community chat is subscription-only, not per-course)
  hasLiveEvents   Boolean  @default(false) // Live Q&A sessions
  hasCertificate  Boolean  @default(false) // Completion certificate
  
  // Affiliate settings
  affiliateEnabled    Boolean @default(true)
  affiliateCommission Float   @default(20)  // Percentage
  
  // Subscription Vault - include in all-access subscription
  includeInSubscription Boolean @default(false)
  
  // Status
  isPublished     Boolean  @default(false)
  isFeatured      Boolean  @default(false)
  
  // Stats (denormalized for performance)
  enrollmentCount Int      @default(0)
  reviewCount     Int      @default(0)
  averageRating   Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  studioId        String
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  creatorId       String?  // Teacher who created (if created by teacher)
  creator         Teacher? @relation("VaultCourseCreator", fields: [creatorId], references: [id], onDelete: SetNull)
  
  // Course structure
  modules         VaultModule[]
  
  // Instructors (can have multiple teachers)
  instructors     VaultCourseInstructor[]
  
  // Enrollments
  enrollments     VaultEnrollment[]
  
  // Affiliate links
  affiliateLinks  VaultAffiliateLink[]
  
  // Reviews
  reviews         VaultReview[]
  
  // Bundles this course is part of
  bundles         VaultBundleCourse[]

  @@index([studioId])
  @@index([audience])
  @@index([isPublished])
  @@index([isFeatured])
}

// Course instructors (many-to-many)
model VaultCourseInstructor {
  id          String   @id @default(cuid())
  role        String   @default("instructor") // lead, instructor, guest
  bio         String?  @db.Text
  
  courseId    String
  course      VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([courseId, teacherId])
}

// Course modules (sections)
model VaultModule {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  order       Int      @default(0)
  
  // Drip settings
  dripDelay   Int?     // Days after enrollment to unlock (null = immediately)
  
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courseId    String
  course      VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  lessons     VaultLesson[]

  @@index([courseId, order])
}

// Individual lessons
model VaultLesson {
  id              String   @id @default(cuid())
  title           String
  description     String?  @db.Text
  order           Int      @default(0)
  
  // Content type
  contentType     String   @default("video") // video, text, pdf, quiz, assignment
  
  // Content
  videoUrl        String?
  videoDuration   Int?     // Duration in seconds
  textContent     String?  @db.Text
  pdfUrl          String?
  
  // Quiz/Assignment content (JSON)
  quizContent     String?  @db.Text
  
  // Preview
  isPreview       Boolean  @default(false) // Free preview before purchase
  
  isPublished     Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  moduleId        String
  module          VaultModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  // Progress tracking
  progress        VaultProgress[]
  
  // Resources/attachments
  resources       VaultLessonResource[]

  @@index([moduleId, order])
}

// Lesson resources/attachments
model VaultLessonResource {
  id          String   @id @default(cuid())
  title       String
  type        String   // pdf, download, link
  url         String
  
  lessonId    String
  lesson      VaultLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

// Course enrollments
model VaultEnrollment {
  id              String   @id @default(cuid())
  
  status          VaultEnrollmentStatus @default(ACTIVE)
  
  // Access dates
  enrolledAt      DateTime @default(now())
  expiresAt       DateTime?
  completedAt     DateTime?
  
  // Progress
  progressPercent Float    @default(0)
  lessonsCompleted Int     @default(0)
  lastAccessedAt  DateTime?
  
  // Payment info
  paidAmount      Float?
  paidAt          DateTime?
  paymentMethod   String?
  transactionId   String?
  
  // Subscription info
  subscriptionId  String?
  subscriptionStatus String?
  nextBillingDate DateTime?
  
  // Affiliate tracking
  affiliateLinkId String?
  affiliateLink   VaultAffiliateLink? @relation(fields: [affiliateLinkId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  courseId        String
  course          VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Who enrolled - can be client, teacher, or user (studio owner)
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  userId          String?  // For studio owners
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Progress records
  progress        VaultProgress[]
  
  // Chat membership
  chatMembership  VaultChatMember?

  @@unique([courseId, clientId])
  @@unique([courseId, teacherId])
  @@unique([courseId, userId])
  @@index([courseId])
  @@index([clientId])
  @@index([teacherId])
  @@index([userId])
  @@index([status])
}

// Lesson progress tracking
model VaultProgress {
  id              String   @id @default(cuid())
  
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  
  // Video progress
  watchedSeconds  Int      @default(0)
  lastPosition    Int      @default(0) // Resume position
  
  // Quiz/Assignment
  quizScore       Float?
  quizAttempts    Int      @default(0)
  submissionData  String?  @db.Text // JSON for assignment submissions
  
  startedAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  enrollmentId    String
  enrollment      VaultEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  lessonId        String
  lesson          VaultLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
}

// Course bundles/memberships
// Vault Subscription Plan - All-access subscription to vault courses
// Each studio can have 3 subscription tiers: STUDIO_OWNERS, TEACHERS, CLIENTS
model VaultSubscriptionPlan {
  id              String   @id @default(cuid())
  
  name            String   // e.g., "Studio Owner Vault", "Teacher Vault", "At-Home Vault"
  description     String   @db.Text
  
  // Which audience this subscription is for
  audience        VaultAudience // STUDIO_OWNERS, TEACHERS, CLIENTS
  
  // Pricing tiers
  monthlyPrice    Float
  quarterlyPrice  Float?
  yearlyPrice     Float?
  currency        String   @default("USD")
  
  // Benefits
  includesAllCourses Boolean @default(true) // Access to all courses for this audience
  includesClasses    Boolean @default(false) // Include studio class credits
  classCreditsPerMonth Int?  // Monthly class credits
  
  // Features display
  features        String[] // List of features to display
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studioId        String
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  subscribers     VaultSubscriber[]
  
  // Community chat for this subscription tier
  communityChat   VaultSubscriptionChat?

  @@unique([studioId, audience]) // Only one plan per audience per studio
  @@index([studioId])
}

// Community chat room for a subscription tier (NOT for individual courses)
model VaultSubscriptionChat {
  id              String   @id @default(cuid())
  
  name            String?  // e.g., "Studio Owners Community"
  description     String?
  
  // Settings
  isEnabled       Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  planId          String   @unique
  plan            VaultSubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  members         VaultSubscriptionChatMember[]
  messages        VaultSubscriptionChatMessage[]
}

// Members of subscription community chat
model VaultSubscriptionChatMember {
  id              String   @id @default(cuid())
  
  role            String   @default("member") // admin, moderator, member
  
  // Notification settings
  notificationsEnabled Boolean @default(true)
  lastReadAt      DateTime?
  
  isMuted         Boolean  @default(false)
  isBanned        Boolean  @default(false)
  
  joinedAt        DateTime @default(now())

  chatId          String
  chat            VaultSubscriptionChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  subscriberId    String   @unique
  subscriber      VaultSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  
  messages        VaultSubscriptionChatMessage[]

  @@unique([chatId, subscriberId])
  @@index([chatId])
}

// Messages in subscription community chat
model VaultSubscriptionChatMessage {
  id              String   @id @default(cuid())
  
  content         String   @db.Text
  type            String   @default("text") // text, image, announcement
  mediaUrl        String?
  
  isEdited        Boolean  @default(false)
  isDeleted       Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  chatId          String
  chat            VaultSubscriptionChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  memberId        String
  member          VaultSubscriptionChatMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([chatId, createdAt])
}

// Active vault subscriptions
model VaultSubscriber {
  id              String   @id @default(cuid())
  
  status          String   @default("active") // active, cancelled, past_due, paused
  interval        String   // monthly, quarterly, yearly
  
  startedAt       DateTime @default(now())
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?
  
  // Payment
  stripeSubscriptionId String?
  paidAmount      Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  planId          String
  plan            VaultSubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  // Subscriber (one of these)
  clientId        String?
  client          Client?  @relation("VaultClientSubscription", fields: [clientId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher? @relation("VaultTeacherSubscription", fields: [teacherId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?    @relation("VaultUserSubscription", fields: [userId], references: [id], onDelete: Cascade)
  
  // Community chat membership
  chatMembership  VaultSubscriptionChatMember?

  @@index([planId])
  @@index([status])
}

model VaultBundle {
  id              String   @id @default(cuid())
  
  title           String
  slug            String   @unique
  description     String   @db.Text
  thumbnailUrl    String?
  
  // Pricing
  price           Float
  currency        String   @default("USD")
  
  // Subscription options
  isSubscription  Boolean  @default(false)
  subscriptionInterval String? // monthly, quarterly, yearly
  
  // Bundle benefits
  includesClasses Boolean  @default(false) // Include studio class credits
  classCredits    Int?     // Number of class credits per period
  
  isPublished     Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studioId        String
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  // Courses in bundle
  courses         VaultBundleCourse[]
  
  // Subscriptions
  subscriptions   VaultBundleSubscription[]

  @@index([studioId])
}

// Bundle-Course relationship
model VaultBundleCourse {
  id          String   @id @default(cuid())
  
  bundleId    String
  bundle      VaultBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  courseId    String
  course      VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([bundleId, courseId])
}

// Bundle subscriptions
model VaultBundleSubscription {
  id              String   @id @default(cuid())
  
  status          String   @default("active") // active, cancelled, past_due
  
  startedAt       DateTime @default(now())
  cancelledAt     DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  
  stripeSubscriptionId String?
  
  bundleId        String
  bundle          VaultBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  
  // Subscriber
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([bundleId])
  @@index([status])
}

// ==================== VAULT COMMUNITY/CHAT ====================

// Chat room for a course
// DEPRECATED: Course-level chat is no longer used. 
// Community chat is now subscription-tier only (see VaultSubscriptionChat).
// Keeping this model for data migration purposes.
model VaultChatRoom {
  id              String   @id @default(cuid())
  
  name            String?
  description     String?
  
  isEnabled       Boolean  @default(true)
  instructorsOnly Boolean  @default(false)
  moderationEnabled Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // No longer linked to course - subscription chats are separate
  deprecatedCourseId String?
  
  members         VaultChatMember[]
  messages        VaultChatMessage[]
  pinnedMessages  VaultChatPinned[]
}

// Chat room members
model VaultChatMember {
  id              String   @id @default(cuid())
  
  role            String   @default("member") // admin, instructor, moderator, member
  
  // Notification settings
  notificationsEnabled Boolean @default(true)
  lastReadAt      DateTime?
  
  isMuted         Boolean  @default(false)
  mutedUntil      DateTime?
  
  isBanned        Boolean  @default(false)
  
  joinedAt        DateTime @default(now())

  chatRoomId      String
  chatRoom        VaultChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  
  enrollmentId    String   @unique
  enrollment      VaultEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  messages        VaultChatMessage[]

  @@index([chatRoomId])
}

// Chat messages
model VaultChatMessage {
  id              String   @id @default(cuid())
  
  content         String   @db.Text
  
  // Message type
  type            String   @default("text") // text, image, file, announcement
  
  // Media (if any)
  mediaUrl        String?
  mediaType       String?  // image, video, file
  fileName        String?
  
  // Reply
  replyToId       String?
  replyTo         VaultChatMessage? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies         VaultChatMessage[] @relation("MessageReplies")
  
  // Status
  isEdited        Boolean  @default(false)
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  chatRoomId      String
  chatRoom        VaultChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  
  memberId        String
  member          VaultChatMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Reactions
  reactions       VaultChatReaction[]
  
  pinnedIn        VaultChatPinned?

  @@index([chatRoomId, createdAt])
}

// Message reactions
model VaultChatReaction {
  id          String   @id @default(cuid())
  emoji       String   // emoji code
  
  messageId   String
  message     VaultChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // Who reacted (store member ID as string to avoid complex relations)
  memberId    String
  
  createdAt   DateTime @default(now())

  @@unique([messageId, memberId, emoji])
}

// Pinned messages
model VaultChatPinned {
  id          String   @id @default(cuid())
  
  chatRoomId  String
  chatRoom    VaultChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  
  messageId   String   @unique
  message     VaultChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  pinnedAt    DateTime @default(now())
  pinnedBy    String   // Member ID who pinned
}

// ==================== VAULT AFFILIATES ====================

// Affiliate links for teachers
model VaultAffiliateLink {
  id              String   @id @default(cuid())
  
  code            String   @unique // Unique referral code
  
  // Custom commission (overrides course default)
  customCommission Float?
  
  // Stats
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  totalEarnings   Float    @default(0)
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  courseId        String
  course          VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Enrollments from this link
  enrollments     VaultEnrollment[]
  
  // Sales records
  sales           VaultAffiliateSale[]

  @@unique([courseId, teacherId])
  @@index([code])
}

// Affiliate sale records
model VaultAffiliateSale {
  id              String   @id @default(cuid())
  
  saleAmount      Float    // Total sale amount
  commissionRate  Float    // Commission % at time of sale
  commissionAmount Float   // Actual commission earned
  
  // Payment status
  status          String   @default("pending") // pending, approved, paid, rejected
  paidAt          DateTime?
  paymentReference String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  affiliateLinkId String
  affiliateLink   VaultAffiliateLink @relation(fields: [affiliateLinkId], references: [id], onDelete: Cascade)
  
  // The enrollment that generated this sale
  enrollmentId    String?

  @@index([affiliateLinkId])
  @@index([status])
}

// ==================== VAULT REVIEWS ====================

model VaultReview {
  id              String   @id @default(cuid())
  
  rating          Int      // 1-5
  title           String?
  content         String?  @db.Text
  
  isVerified      Boolean  @default(true)  // From verified purchaser
  isApproved      Boolean  @default(true)  // Moderation
  isFeatured      Boolean  @default(false)
  
  // Helpful votes
  helpfulCount    Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  courseId        String
  course          VaultCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Reviewer (one of these)
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  teacher         Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([rating])
}

// ===========================================
// E-COMMERCE / MERCHANDISE STORE
// ===========================================

enum ProductCategory {
  APPAREL
  EQUIPMENT
  ACCESSORIES
  NUTRITION
  WELLNESS
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum SampleOrderStatus {
  PENDING
  APPROVED
  SHIPPED
  DELIVERED
  CANCELLED
}

// Master product catalog (managed by HQ)
model Product {
  id              String   @id @default(cuid())
  
  name            String
  slug            String   @unique
  description     String   @db.Text
  shortDescription String?
  
  category        ProductCategory
  subcategory     String?
  
  // Base pricing (wholesale/cost)
  baseCost        Float
  suggestedRetail Float
  
  // Images
  images          String[]  // Array of image URLs
  
  // Customization options
  canAddLogo      Boolean   @default(true)
  logoPlacement   String[]  // e.g., ["front", "back", "sleeve"]
  
  // Inventory
  inStock         Boolean   @default(true)
  leadTimeDays    Int       @default(7)
  
  // Metadata
  weight          Float?    // in kg
  dimensions      String?   // e.g., "30x20x10cm"
  materials       String?
  careInstructions String?
  
  status          ProductStatus @default(ACTIVE)
  isFeatured      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  variants        ProductVariant[]
  studioProducts  StudioProduct[]
  sampleOrderItems SampleOrderItem[]
  
  @@index([category])
  @@index([status])
}

// Product variants (sizes, colors)
model ProductVariant {
  id              String   @id @default(cuid())
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  sku             String   @unique
  name            String   // e.g., "Small / Black"
  
  size            String?  // e.g., "S", "M", "L", "XL"
  color           String?
  colorHex        String?  // e.g., "#000000"
  
  // Variant-specific pricing adjustment
  priceAdjustment Float    @default(0)
  
  // Inventory
  inStock         Boolean  @default(true)
  stockQuantity   Int?
  
  images          String[] // Variant-specific images
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  studioProductVariants StudioProductVariant[]
  orderItems      MerchOrderItem[]
  sampleOrderItems SampleOrderItem[]
  
  @@index([productId])
}

// Studio's store configuration
model StudioStore {
  id              String   @id @default(cuid())
  
  studioId        String   @unique
  studio          Studio   @relation(fields: [studioId], references: [id], onDelete: Cascade)
  
  // Store settings
  isEnabled       Boolean  @default(false)
  storeName       String?
  storeDescription String?
  
  // Branding
  logoUrl         String?
  bannerUrl       String?
  accentColor     String?
  
  // Shipping settings
  freeShippingThreshold Float?
  flatShippingRate Float?
  
  // Policies
  returnPolicy    String?  @db.Text
  shippingInfo    String?  @db.Text
  
  // Connected Stripe for payouts
  stripeAccountId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  products        StudioProduct[]
  orders          MerchOrder[]
  sampleOrders    SampleOrder[]
}

// Products listed in a studio's store
model StudioProduct {
  id              String   @id @default(cuid())
  
  storeId         String
  store           StudioStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Custom pricing
  price           Float    // Studio's retail price
  compareAtPrice  Float?   // Original price for showing discount
  
  // Customization
  hasCustomLogo   Boolean  @default(false)
  logoUrl         String?  // Studio's logo for this product
  logoPlacement   String?  // Where logo is placed
  
  // Custom content
  customTitle     String?
  customDescription String? @db.Text
  
  // Status
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  variants        StudioProductVariant[]
  orderItems      MerchOrderItem[]
  
  @@unique([storeId, productId])
  @@index([storeId])
}

// Studio-specific variant settings
model StudioProductVariant {
  id              String   @id @default(cuid())
  
  studioProductId String
  studioProduct   StudioProduct @relation(fields: [studioProductId], references: [id], onDelete: Cascade)
  
  variantId       String
  variant         ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  // Override pricing
  price           Float?
  
  // Availability
  isActive        Boolean  @default(true)
  
  @@unique([studioProductId, variantId])
}

// Sample orders for studios to try products
model SampleOrder {
  id              String   @id @default(cuid())
  
  storeId         String
  store           StudioStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  status          SampleOrderStatus @default(PENDING)
  
  // Shipping
  shippingName    String
  shippingAddress String
  shippingCity    String
  shippingState   String
  shippingZip     String
  shippingCountry String   @default("US")
  
  // Tracking
  trackingNumber  String?
  trackingUrl     String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  // Cost (may be free or discounted for samples)
  subtotal        Float
  shippingCost    Float    @default(0)
  discount        Float    @default(0)
  total           Float
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           SampleOrderItem[]
  
  @@index([storeId])
  @@index([status])
}

// Items in a sample order
model SampleOrderItem {
  id              String   @id @default(cuid())
  
  orderId         String
  order           SampleOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  
  quantity        Int      @default(1)
  unitPrice       Float
  
  // For logo samples
  includeLogoSample Boolean @default(false)
  logoUrl         String?
  
  @@index([orderId])
}

// Customer orders
model MerchOrder {
  id              String   @id @default(cuid())
  
  orderNumber     String   @unique
  
  storeId         String
  store           StudioStore @relation(fields: [storeId], references: [id])
  
  // Customer info (can be linked to Client or guest)
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id])
  
  customerEmail   String
  customerName    String
  customerPhone   String?
  
  // Shipping
  shippingName    String
  shippingAddress String
  shippingAddress2 String?
  shippingCity    String
  shippingState   String
  shippingZip     String
  shippingCountry String   @default("US")
  
  // Order totals
  subtotal        Float
  shippingCost    Float
  taxAmount       Float    @default(0)
  discount        Float    @default(0)
  total           Float
  
  // Payment
  paymentStatus   String   @default("pending")
  paymentMethod   String?
  stripePaymentId String?
  paidAt          DateTime?
  
  // Fulfillment
  status          OrderStatus @default(PENDING)
  trackingNumber  String?
  trackingUrl     String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  // Payout to studio
  studioEarnings  Float?
  platformFee     Float?
  payoutStatus    String?  @default("pending")
  paidOutAt       DateTime?
  
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           MerchOrderItem[]
  
  @@index([storeId])
  @@index([status])
  @@index([customerEmail])
}

// Items in a customer order
model MerchOrderItem {
  id              String   @id @default(cuid())
  
  orderId         String
  order           MerchOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  studioProductId String
  studioProduct   StudioProduct @relation(fields: [studioProductId], references: [id])
  
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Snapshot at time of order
  productName     String
  variantName     String?
  
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  
  // Customization applied
  hasCustomLogo   Boolean  @default(false)
  logoUrl         String?
  
  // Fulfillment
  fulfilledQuantity Int    @default(0)
  
  @@index([orderId])
}

// ==========================================
// LEADERBOARDS & PRIZES SYSTEM
// ==========================================

enum LeaderboardCategory {
  // Content & Social Media
  MOST_CONTENT_POSTED
  MOST_SOCIAL_VIEWS
  MOST_SOCIAL_LIKES
  MOST_SOCIAL_ENGAGEMENT
  CONTENT_CONSISTENCY
  
  // Growth Metrics
  FASTEST_GROWING
  BIGGEST_GROWTH_MONTHLY
  BIGGEST_GROWTH_QUARTERLY
  MOST_NEW_CLIENTS
  HIGHEST_RETENTION
  
  // Course/Vault Metrics
  MOST_COURSES_COMPLETED
  MOST_COURSE_ENROLLMENTS
  TOP_COURSE_CREATOR
  BEST_COURSE_RATINGS
  
  // Booking & Revenue
  MOST_BOOKINGS
  HIGHEST_ATTENDANCE_RATE
  MOST_CLASSES_TAUGHT
  TOP_REVENUE
  
  // Engagement
  MOST_ACTIVE_COMMUNITY
  TOP_REVIEWER
  MOST_REFERRALS
  
  // Special Categories
  NEWCOMER_OF_MONTH
  COMEBACK_CHAMPION
  ALL_ROUNDER
}

enum LeaderboardTimeframe {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  ALL_TIME
}

enum LeaderboardParticipantType {
  STUDIO
  TEACHER
}

enum PrizeType {
  CASH
  GIFT_CARD
  HOLIDAY
  MERCHANDISE
  SUBSCRIPTION
  FEATURE_SPOTLIGHT
  BADGE
  OTHER
}

enum LeaderboardStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

// Defines a leaderboard competition
model Leaderboard {
  id              String   @id @default(cuid())
  
  name            String
  slug            String   @unique
  description     String?  @db.Text
  
  category        LeaderboardCategory
  participantType LeaderboardParticipantType
  timeframe       LeaderboardTimeframe
  
  // Scoring
  metricName      String   // e.g., "posts", "views", "new_clients"
  metricUnit      String?  // e.g., "posts", "views", "%"
  higherIsBetter  Boolean  @default(true)
  minimumEntries  Int      @default(1)  // Minimum activity to qualify
  
  // Display
  icon            String?  // Icon name for UI
  color           String?  // Brand color for the leaderboard
  badgeImageUrl   String?  // Badge for winners
  
  // Configuration
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  showOnDashboard Boolean  @default(true)
  
  // Auto-calculation settings
  autoCalculate   Boolean  @default(true)
  calculationCron String?  // e.g., "0 0 * * *" for daily
  lastCalculated  DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  periods         LeaderboardPeriod[]
  prizes          LeaderboardPrize[]
  
  @@index([category])
  @@index([participantType])
  @@index([isActive])
}

// Prizes available for a leaderboard
model LeaderboardPrize {
  id              String   @id @default(cuid())
  
  leaderboardId   String
  leaderboard     Leaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  
  position        Int      // 1st, 2nd, 3rd, etc.
  name            String   // e.g., "Bali Retreat", "$500 Cash"
  description     String?  @db.Text
  
  prizeType       PrizeType
  prizeValue      Float?   // Monetary value
  prizeCurrency   String?  @default("USD")
  
  // Prize details
  prizeDetails    Json?    // Additional details like gift card brand, holiday destination
  imageUrl        String?
  
  // Sponsor info
  sponsorName     String?
  sponsorLogo     String?
  sponsorUrl      String?
  
  createdAt       DateTime @default(now())
  
  winners         LeaderboardWinner[]
  
  @@unique([leaderboardId, position])
  @@index([leaderboardId])
}

// A specific time period for a leaderboard (e.g., January 2025)
model LeaderboardPeriod {
  id              String   @id @default(cuid())
  
  leaderboardId   String
  leaderboard     Leaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  
  name            String   // e.g., "January 2025", "Q1 2025"
  startDate       DateTime
  endDate         DateTime
  
  status          LeaderboardStatus @default(ACTIVE)
  
  // When winners were finalized
  finalizedAt     DateTime?
  finalizedBy     String?  // Admin user ID
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  entries         LeaderboardEntry[]
  winners         LeaderboardWinner[]
  
  @@unique([leaderboardId, startDate])
  @@index([leaderboardId])
  @@index([status])
}

// Individual entries/scores in a leaderboard period
model LeaderboardEntry {
  id              String   @id @default(cuid())
  
  periodId        String
  period          LeaderboardPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  
  // Participant (either studio or teacher)
  studioId        String?
  teacherId       String?
  
  // Score/metrics
  score           Float
  previousScore   Float?   // For showing change
  rank            Int?     // Calculated rank
  previousRank    Int?     // For showing movement
  
  // Detailed metrics breakdown
  metricsBreakdown Json?   // Store detailed metrics
  
  // Tracking
  lastUpdated     DateTime @default(now())
  
  createdAt       DateTime @default(now())
  
  @@unique([periodId, studioId])
  @@unique([periodId, teacherId])
  @@index([periodId])
  @@index([rank])
}

// Winners of prizes
model LeaderboardWinner {
  id              String   @id @default(cuid())
  
  periodId        String
  period          LeaderboardPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  
  prizeId         String
  prize           LeaderboardPrize @relation(fields: [prizeId], references: [id])
  
  // Winner (either studio or teacher)
  studioId        String?
  teacherId       String?
  
  position        Int      // Final position
  finalScore      Float    // Score at time of win
  
  // Prize fulfillment
  prizeStatus     String   @default("pending")  // pending, claimed, fulfilled, expired
  claimedAt       DateTime?
  fulfilledAt     DateTime?
  
  // Prize delivery details
  deliveryDetails Json?    // Address, preferences, etc.
  notes           String?  @db.Text
  
  // Notification
  notifiedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([periodId, prizeId])
  @@index([periodId])
  @@index([prizeStatus])
}

// Track achievements and badges earned
model LeaderboardBadge {
  id              String   @id @default(cuid())
  
  name            String
  description     String?
  imageUrl        String
  
  // Requirements
  category        LeaderboardCategory?
  requiredWins    Int      @default(1)
  requiredRank    Int?     // Must achieve this rank or better
  
  // Styling
  color           String?
  rarity          String   @default("common")  // common, rare, epic, legendary
  
  createdAt       DateTime @default(now())
  
  earnedBadges    EarnedBadge[]
}

// Badges earned by studios/teachers
model EarnedBadge {
  id              String   @id @default(cuid())
  
  badgeId         String
  badge           LeaderboardBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  // Earned by (either studio or teacher)
  studioId        String?
  teacherId       String?
  
  earnedAt        DateTime @default(now())
  
  // What triggered earning this badge
  triggeredBy     String?  // e.g., "leaderboard_win", "streak", "milestone"
  triggerDetails  Json?
  
  @@unique([badgeId, studioId])
  @@unique([badgeId, teacherId])
  @@index([studioId])
  @@index([teacherId])
}

// ==========================================
// SUPPORT CHAT SYSTEM
// ==========================================

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Support conversation/ticket
model SupportConversation {
  id              String   @id @default(cuid())
  
  subject         String   // Brief topic of the conversation
  status          SupportTicketStatus @default(OPEN)
  priority        SupportPriority @default(MEDIUM)
  
  // Who initiated (either studio owner via User or teacher)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  teacherId       String?
  // Note: Teacher relation handled manually to avoid circular ref issues
  
  // Studio context (for easy filtering)
  studioId        String?
  
  // Assigned HQ agent
  assignedToId    String?  // User ID of HQ admin
  
  // Metadata
  category        String?  // e.g., "billing", "technical", "feature_request"
  tags            String[]
  
  // Read status
  lastMessageAt   DateTime @default(now())
  unreadByHQ      Boolean  @default(true)
  unreadByUser    Boolean  @default(false)
  
  // Resolution
  resolvedAt      DateTime?
  resolvedById    String?
  satisfactionRating Int?  // 1-5
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  messages        SupportMessage[]
  
  @@index([status])
  @@index([userId])
  @@index([teacherId])
  @@index([studioId])
  @@index([assignedToId])
  @@index([lastMessageAt])
}

// Individual support messages
model SupportMessage {
  id              String   @id @default(cuid())
  
  conversationId  String
  conversation    SupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  content         String   @db.Text
  
  // Who sent it
  senderType      String   // "user", "teacher", "hq"
  senderId        String   // User or Teacher ID
  senderName      String   // Display name at time of sending
  
  // Attachments
  attachments     String[] // URLs to attachments
  
  // Status
  isRead          Boolean  @default(false)
  readAt          DateTime?
  
  // For system messages
  isSystemMessage Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@index([conversationId, createdAt])
}

// ==========================================
// SALES CRM SYSTEM
// ==========================================

enum LeadStatus {
  NEW
  CONTACTED
  DEMO_REQUESTED
  QUALIFIED
  DEMO_SCHEDULED
  DEMO_COMPLETED
  WON
  LOST
  NURTURING
}

enum LeadSource {
  INBOUND_WEBSITE
  INBOUND_DEMO
  OUTBOUND_COLD
  OUTBOUND_EMAIL
  REFERRAL
  SOCIAL_MEDIA
  PARTNERSHIP
  EVENT
  OTHER
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  HOT
}

enum ActivityType {
  CALL
  EMAIL
  SMS
  MEETING
  DEMO
  NOTE
  STATUS_CHANGE
  TASK_COMPLETED
  SYSTEM
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Sales Agent - extends User for HQ staff doing sales
model SalesAgent {
  id              String   @id @default(cuid())
  
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Agent info
  title           String?  // e.g., "Sales Representative", "Account Executive"
  phone           String?
  calendarLink    String?  // Calendly or similar link
  
  // Settings
  isActive        Boolean  @default(true)
  canReceiveLeads Boolean  @default(true)
  maxLeads        Int?     // Max leads they can handle
  
  // Stats (denormalized for performance)
  totalLeads      Int      @default(0)
  totalWon        Int      @default(0)
  totalLost       Int      @default(0)
  totalRevenue    Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  leads           Lead[]
  activities      LeadActivity[]
  tasks           LeadTask[]
  calendarEvents  SalesCalendarEvent[]
  demoBookings    DemoBooking[]
  
  @@index([isActive])
}

// Lead/Prospect
model Lead {
  id              String   @id @default(cuid())
  
  // Business info
  studioName      String
  website         String?
  
  // Contact person
  contactName     String
  contactEmail    String
  contactPhone    String?
  contactRole     String?  // e.g., "Owner", "Manager"
  
  // Location
  city            String?
  state           String?
  country         String   @default("US")
  timezone        String?
  
  // Lead details
  status          LeadStatus @default(NEW)
  source          LeadSource @default(OTHER)
  priority        LeadPriority @default(MEDIUM)
  
  // Business context
  currentSoftware String?  // What they're using now
  studioSize      String?  // e.g., "1-5 instructors", "6-15", "16+"
  monthlyRevenue  String?  // Revenue range
  painPoints      String?  @db.Text // What problems they have
  notes           String?  @db.Text // General notes
  
  // Deal info
  estimatedValue  Float?   // Estimated deal value
  probability     Int?     // Win probability 0-100
  expectedClose   DateTime? // Expected close date
  
  // Lost/Won tracking
  lostReason      String?
  wonDate         DateTime?
  actualValue     Float?   // Actual deal value if won
  
  // Assignment
  assignedToId    String?
  assignedTo      SalesAgent? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt      DateTime?
  
  // Communication tracking
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  totalCalls      Int      @default(0)
  totalEmails     Int      @default(0)
  totalSms        Int      @default(0)
  
  // Tags for organization
  tags            String[]
  
  // If converted to actual studio
  convertedStudioId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  activities      LeadActivity[]
  tasks           LeadTask[]
  demoBookings    DemoBooking[]
  calendarEvents  SalesCalendarEvent[] @relation("CalendarEventLead")
  hqMessages      HQMessage[]
  
  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@index([priority])
  @@index([nextFollowUpAt])
  @@index([createdAt])
}

// Activity/Communication log for leads
model LeadActivity {
  id              String   @id @default(cuid())
  
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  type            ActivityType
  
  // Content
  subject         String?  // For emails
  content         String   @db.Text // The actual note, email body, call notes
  
  // Communication details
  direction       String?  // "inbound" or "outbound"
  duration        Int?     // Call duration in seconds
  outcome         String?  // e.g., "Left voicemail", "Spoke with decision maker"
  
  // For emails/SMS
  toAddress       String?
  fromAddress     String?
  externalId      String?  // Email/SMS provider message ID
  
  // Status change tracking
  previousStatus  String?
  newStatus       String?
  
  // Who performed the activity
  agentId         String?
  agent           SalesAgent? @relation(fields: [agentId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  
  @@index([leadId, createdAt])
  @@index([agentId])
  @@index([type])
}

// Tasks and follow-ups
model LeadTask {
  id              String   @id @default(cuid())
  
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?  @db.Text
  
  type            String   @default("follow_up") // follow_up, call, email, meeting, demo, other
  status          TaskStatus @default(PENDING)
  priority        TaskPriority @default(MEDIUM)
  
  dueDate         DateTime
  reminderAt      DateTime?
  completedAt     DateTime?
  
  // Assignment
  assignedToId    String?
  assignedTo      SalesAgent? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([leadId])
  @@index([assignedToId])
  @@index([status, dueDate])
  @@index([dueDate])
}

// Demo bookings (inbound from website)
model DemoBooking {
  id              String   @id @default(cuid())
  
  // Contact info (from form)
  studioName      String
  contactName     String
  contactEmail    String
  contactPhone    String?
  
  // Booking details
  requestedDate   DateTime? // Preferred date/time
  scheduledDate   DateTime? // Actual scheduled date
  duration        Int      @default(30) // Duration in minutes
  meetingLink     String?  // Zoom/Meet link
  
  // Context from form
  studioSize      String?
  currentSoftware String?
  interests       String?  @db.Text // What they're interested in
  referralSource  String?  // How they heard about us
  
  // Status
  status          String   @default("pending") // pending, scheduled, completed, cancelled, no_show
  
  // Assignment
  assignedToId    String?
  assignedTo      SalesAgent? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  
  // Link to lead (created or existing)
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Notes
  notes           String?  @db.Text
  outcome         String?  // Post-demo outcome
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([assignedToId])
  @@index([scheduledDate])
}

// Sales agent calendar events
model SalesCalendarEvent {
  id              String   @id @default(cuid())
  
  agentId         String
  agent           SalesAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?  @db.Text
  
  // Time
  startTime       DateTime
  endTime         DateTime
  allDay          Boolean  @default(false)
  timezone        String   @default("America/New_York")
  
  // Type
  type            String   @default("meeting") // meeting, call, demo, blocked, other
  
  // Related entities
  leadId          String?
  lead            Lead?    @relation("CalendarEventLead", fields: [leadId], references: [id], onDelete: SetNull)
  demoBookingId   String?
  
  // Meeting details
  location        String?  // Physical location or video link
  meetingLink     String?
  
  // Reminders
  reminderMinutes Int?     // Minutes before to remind
  
  // Status
  status          String   @default("scheduled") // scheduled, completed, cancelled
  
  // External calendar sync
  externalCalendarId String?
  externalEventId    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([agentId, startTime])
  @@index([startTime])
  @@index([leadId])
}
