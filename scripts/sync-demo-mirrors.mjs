#!/usr/bin/env node

import fs from "node:fs/promises"
import path from "node:path"

const repoRoot = process.cwd()

const MIRRORS = [
  {
    source: "src/app/(dashboard)/studio/reports/page.tsx",
    target: "src/app/demo/reports/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/schedule/new/page.tsx",
    target: "src/app/demo/schedule/new/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/schedule/[classId]/page.tsx",
    target: "src/app/demo/schedule/[classId]/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/teachers/[teacherId]/page.tsx",
    target: "src/app/demo/teachers/[teacherId]/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/clients/[clientId]/page.tsx",
    target: "src/app/demo/clients/[clientId]/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/classes/[classTypeId]/page.tsx",
    target: "src/app/demo/classes/[classTypeId]/page.tsx",
  },
  {
    source: "src/app/(dashboard)/studio/locations/[locationId]/page.tsx",
    target: "src/app/demo/locations/[locationId]/page.tsx",
  },
]

const HEADER = [
  "// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY",
  "// Generated by scripts/sync-demo-mirrors.mjs from studio route source.",
  "",
].join("\n")

function toDemoSource(content) {
  const normalized = content
    .replaceAll("/api/studio/", "/api/demo/")
    .replaceAll("/studio/", "/demo/")
  return `${HEADER}${normalized.replace(/^\/\/ AUTO-GENERATED FILE[^\n]*\n\/\/ Generated by[^\n]*\n\n/, "")}`
}

async function syncOne({ source, target }) {
  const sourcePath = path.join(repoRoot, source)
  const targetPath = path.join(repoRoot, target)
  const sourceContent = await fs.readFile(sourcePath, "utf8")
  const nextContent = toDemoSource(sourceContent)

  await fs.mkdir(path.dirname(targetPath), { recursive: true })

  let existing = null
  try {
    existing = await fs.readFile(targetPath, "utf8")
  } catch {
    existing = null
  }

  if (existing === nextContent) {
    return { target, changed: false }
  }

  await fs.writeFile(targetPath, nextContent, "utf8")
  return { target, changed: true }
}

async function main() {
  const results = []
  for (const mirror of MIRRORS) {
    results.push(await syncOne(mirror))
  }

  const changed = results.filter((result) => result.changed).map((result) => result.target)
  if (changed.length === 0) {
    console.log("demo:sync up to date")
    return
  }

  console.log(`demo:sync updated ${changed.length} file(s):`)
  for (const target of changed) {
    console.log(`- ${target}`)
  }
}

main().catch((error) => {
  console.error("demo:sync failed")
  console.error(error)
  process.exit(1)
})
