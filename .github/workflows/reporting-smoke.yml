name: Reporting Smoke

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  reporting-smoke:
    name: Reporting regression smoke tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      TEST_OWNER_COOKIE: ${{ secrets.TEST_OWNER_COOKIE }}
      TEST_TEACHER_COOKIE: ${{ secrets.TEST_TEACHER_COOKIE }}
      TEST_STUDIO_CLIENT_ID: ${{ secrets.TEST_STUDIO_CLIENT_ID }}
      TEST_STUDIO_TEACHER_ID: ${{ secrets.TEST_STUDIO_TEACHER_ID }}
      TEST_STUDIO_CLASS_ID: ${{ secrets.TEST_STUDIO_CLASS_ID }}
      TEST_STUDIO_LOCATION_ID: ${{ secrets.TEST_STUDIO_LOCATION_ID }}
      TEST_REQUIRE_REPORT_DATA: ${{ secrets.TEST_REQUIRE_REPORT_DATA }}
      TEST_REQUIRE_REPORT_INTEGRITY: ${{ secrets.TEST_REQUIRE_REPORT_INTEGRITY }}
      TEST_FAIL_ON_SKIP: ${{ secrets.TEST_FAIL_ON_SKIP }}
      TEST_BASE_URL: ${{ secrets.TEST_BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run reporting smoke tests
        id: reporting_smoke
        shell: bash
        run: |
          set +e
          pnpm test:smoke:reporting
          test_exit_code=$?

          if [ "$test_exit_code" -eq 0 ]; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
            echo "Reporting smoke tests passed (including any intentional skips)."
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
            echo "Reporting smoke tests failed."
          fi

          exit "$test_exit_code"

      - name: Reporting smoke summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Reporting Smoke Result"
            echo "- Workflow: reporting-smoke.yml"
            echo "- Command: pnpm test:smoke:reporting"
            echo "- Result: **${{ steps.reporting_smoke.outputs.result || 'fail' }}**"
            echo "- Note: Skipped tests are treated as successful run outcomes when the test command exits 0."
          } >> "$GITHUB_STEP_SUMMARY"

          echo "Reporting smoke summary written to job summary."
